
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Provider-agnostic AI SDK ‚Äî docs">
      
      
        <meta name="author" content="ImRabo">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>imrabo-ai-sdk ‚Äî SDK Contract (Formal Spec) - imrabo AI SDK</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#imrabo-ai-sdk-sdk-contract-formal-spec" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="imrabo AI SDK" class="md-header__button md-logo" aria-label="imrabo AI SDK" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            imrabo AI SDK
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              imrabo-ai-sdk ‚Äî SDK Contract (Formal Spec)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/imrabo/imrabo-ai-sdk" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    imrabo/imrabo-ai-sdk
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="imrabo AI SDK" class="md-nav__button md-logo" aria-label="imrabo AI SDK" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    imrabo AI SDK
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/imrabo/imrabo-ai-sdk" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    imrabo/imrabo-ai-sdk
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sdk_contract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Contract
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../provider_adapters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Provider Adapters
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sdk_principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Principles
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-purpose-scope" class="md-nav__link">
    <span class="md-ellipsis">
      
        0. Purpose &amp; Scope üîí
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-high-level-principles-referenced-in-docssdk-principlesmd" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. High-level Principles (referenced in docs/sdk-principles.md) ‚úÖ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-public-api-v1-the-product-surface" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Public API (v1) ‚Äî The Product Surface ‚ú®
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Public API (v1) ‚Äî The Product Surface ‚ú®">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-entry-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Entry Points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-types-public-frozen" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Types ‚Äî Public (frozen)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-streaming-model-non-negotiable" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Streaming Model (non-negotiable) ‚ö°Ô∏è
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-capabilities-system-contract" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Capabilities System (contract)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-provider-adapter-contract-only-extension-point" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Provider Adapter Contract (ONLY extension point) üîå
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-internal-request-normalization-and-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Internal Request Normalization and Validation ‚úÖ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-error-model-typed-deterministic" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Error Model (typed &amp; deterministic) üö®
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-internal-architecture-import-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Internal Architecture &amp; Import Rules üèóÔ∏è
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-provider-implementation-order-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Provider Implementation Order (recommended)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-conformance-tests-acceptance-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Conformance Tests &amp; Acceptance Criteria ‚úÖ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-versioning-compatibility-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Versioning &amp; Compatibility Policy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-security-privacy-notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Security &amp; Privacy Notes üîê
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-documentation-onboarding" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Documentation &amp; Onboarding
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-conformance-checklist-quick" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. Conformance Checklist (quick) ‚úÖ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-final-lock-statement" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. Final Lock Statement
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="imrabo-ai-sdk-sdk-contract-formal-spec">imrabo-ai-sdk ‚Äî SDK Contract (Formal Spec)</h1>
<blockquote>
<p>Locked specification for the imrabo AI SDK public API, extension surfaces, provider contract, and conformance tests. This document is the canonical source for implementers and reviewers.</p>
</blockquote>
<hr />
<h2 id="0-purpose-scope">0. Purpose &amp; Scope üîí</h2>
<p>This document defines the <em>API contract</em> for the imrabo AI SDK. The SDK is a provider-agnostic invocation layer that exposes a single stable surface for calling AI models (local or remote) and does not own execution.</p>
<p>Non-goals (explicit): runtime management, process management, agent frameworks, memory and persistence, UI, or CLIs. The SDK is purely an invocation and normalization layer.</p>
<hr />
<h2 id="1-high-level-principles-referenced-in-docssdk-principlesmd">1. High-level Principles (referenced in <code>docs/sdk-principles.md</code>) ‚úÖ</h2>
<ul>
<li>Invocation over execution</li>
<li>Capabilities over promises</li>
<li>Streaming first</li>
<li>URL-first, kernel-second</li>
<li>Adapters adapt ‚Äî core never bends</li>
<li>Additive evolution only</li>
</ul>
<p>These rules are normative and must be enforced by validation and tests.</p>
<hr />
<h2 id="2-public-api-v1-the-product-surface">2. Public API (v1) ‚Äî The Product Surface ‚ú®</h2>
<h3 id="21-entry-points">2.1 Entry Points</h3>
<p>The SDK exposes exactly these two public operations:</p>
<pre><code class="language-ts">// core/generate.ts
export function generate(request: GenerateRequest): Promise&lt;GenerateResult&gt;

// core/stream.ts
export function stream(request: GenerateRequest): AsyncIterable&lt;StreamChunk&gt;
</code></pre>
<p>No additional helpers, provider-specific shims, or sugar functions are part of the public v1 surface.</p>
<h3 id="22-types-public-frozen">2.2 Types ‚Äî Public (frozen)</h3>
<pre><code class="language-ts">interface GenerateRequest {
  model: string
  messages: Message[]

  runtime?: RuntimeConfig
  tools?: ToolDefinition[]
  options?: GenerationOptions
}

interface Message {
  role: 'system' | 'user' | 'assistant'
  content: string
}

interface RuntimeConfig {
  type: 'url' | 'kernel'
  endpoint?: string        // http(s)://... (required for type=url)
  headers?: Record&lt;string, string&gt;
  timeoutMs?: number
}

interface GenerationOptions {
  maxTokens?: number
  temperature?: number
  topP?: number
  stop?: string[]
}

interface GenerateResult {
  output: string
  tokens?: number
  metadata?: Record&lt;string, any&gt;
}
</code></pre>
<p>Rules: no provider-specific fields allowed in these interfaces. Default values are not implied by the SDK ‚Äî callers must supply explicit choices where needed.</p>
<hr />
<h2 id="3-streaming-model-non-negotiable">3. Streaming Model (non-negotiable) ‚ö°Ô∏è</h2>
<p>Streaming is a first-class mode. The public <code>stream</code> operation returns an AsyncIterable of StreamChunk:</p>
<pre><code class="language-ts">interface StreamChunk {
  type: 'token' | 'tool_call' | 'done' | 'error'
  value?: string | ToolCall
}
</code></pre>
<p>Rules:
- Tokens must arrive incrementally in the order they are generated.
- Providers that cannot stream must set <code>capabilities().streaming === false</code>.
- If a caller requests streaming but the resolved provider reports streaming=false, the SDK must throw <code>UnsupportedCapabilityError</code> (no silent downgrade).
- <code>done</code> is sent once when generation is complete; <code>error</code> may be emitted as the final chunk for streaming errors.
- Tool interactions (if supported) are flagged via <code>tool_call</code> chunk type.</p>
<p>Note: The SDK does not standardize wire-level SSE vs chunked vs websocket ‚Äî that is a provider implementation detail. The provider must expose streaming semantics through the <code>stream</code> method defined in the provider contract.</p>
<hr />
<h2 id="4-capabilities-system-contract">4. Capabilities System (contract)</h2>
<pre><code class="language-ts">interface Capabilities {
  streaming: boolean
  tools: boolean
  json: boolean
  maxTokens?: number
}
</code></pre>
<p>Enforcement rules:
- The SDK checks <code>provider.capabilities()</code> prior to execution.
- If the request asks for a feature not supported by the provider (e.g., <code>tools</code> or streaming), the SDK throws <code>UnsupportedCapabilityError</code> with deterministic messaging.
- Capability checks are deterministic and must be exercised early.</p>
<hr />
<h2 id="5-provider-adapter-contract-only-extension-point">5. Provider Adapter Contract (ONLY extension point) üîå</h2>
<pre><code class="language-ts">interface Provider {
  id: string

  capabilities(): Capabilities

  generate(req: InternalRequest): Promise&lt;GenerateResult&gt;

  stream(req: InternalRequest): AsyncIterable&lt;StreamChunk&gt;
}
</code></pre>
<p>Hard rules for providers:
- A provider must be a pure implementation: no side effects, no internal persistent state, and no importing other providers.
- Providers MUST NOT mutate incoming requests; SDK sends a normalized InternalRequest.
- Providers must not swallow or transform errors silently; they must raise typed errors as specified.
- Providers must not perform automatic retries unless explicitly exposed by configuration (and such behavior must be transparent to the SDK and tests).</p>
<p>Provider Registration:
- Providers are registered in <code>providers/index.ts</code> and loaded by <code>config/resolveProvider.ts</code> using deterministic rules (e.g., <code>runtime.type</code> and <code>runtime.endpoint</code> for url types).</p>
<hr />
<h2 id="6-internal-request-normalization-and-validation">6. Internal Request Normalization and Validation ‚úÖ</h2>
<p>Public requests are normalized into <code>InternalRequest</code> before being passed to providers.</p>
<pre><code class="language-ts">interface InternalRequest {
  model: string
  messages: Message[]
  tools?: ToolDefinition[]
  options?: GenerationOptions
}
</code></pre>
<p>Normalizer responsibilities:
- Validate message ordering and role values.
- Enforce or check <code>options.maxTokens</code> against provider <code>capabilities().maxTokens</code> if present.
- Reject unsupported combinations (e.g., tools requested when provider has tools=false).
- Produce deterministic, immutable InternalRequest objects for providers to consume.</p>
<p>All validation errors raised here are <code>SDKValidationError</code> with deterministic messages and error codes for programmatic handling.</p>
<hr />
<h2 id="7-error-model-typed-deterministic">7. Error Model (typed &amp; deterministic) üö®</h2>
<p>Error types (exported):
- <code>SDKValidationError</code>
- <code>UnsupportedCapabilityError</code>
- <code>ProviderError</code>
- <code>TransportError</code>
- <code>TimeoutError</code></p>
<p>Guidelines:
- All errors must contain a machine-friendly <code>code</code> string and a deterministic human message.
- Providers should wrap provider-specific errors in <code>ProviderError</code> with a consistent shape: <code>{ code, message, providerId, details? }</code>.
- SDK must never swallow or obfuscate provider errors.</p>
<p>Example error object:</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;UnsupportedCapabilityError&quot;,
  &quot;code&quot;: &quot;streaming_not_supported&quot;,
  &quot;message&quot;: &quot;Provider 'foo' does not support streaming&quot;,
  &quot;provider&quot;: &quot;foo&quot;
}
</code></pre>
<hr />
<h2 id="8-internal-architecture-import-rules">8. Internal Architecture &amp; Import Rules üèóÔ∏è</h2>
<p>Minimal structure (implementation folder names are normative):</p>
<pre><code>core/
  generate.ts
  stream.ts
  validate.ts
  normalize.ts
  capabilities.ts
  errors.ts
providers/
  generic_url.ts  // MUST be first
  ollama.ts
  kernel.ts       // later
  index.ts
transport/
  http.ts
  streaming.ts
config/
  resolveProvider.ts
docs/
  sdk-contract.md
</code></pre>
<p>Import rules:
- <code>core</code> must not import from <code>providers</code>.
- <code>providers</code> may depend on <code>transport</code> but not on <code>core</code> or other providers.
- <code>transport</code> must not contain SDK logic; it's focused on HTTP and streaming primitives.</p>
<p>Violation of these rules is considered an architectural bug.</p>
<hr />
<h2 id="9-provider-implementation-order-recommended">9. Provider Implementation Order (recommended)</h2>
<p>Phase 1 ‚Äî <strong>Generic URL Provider (MANDATORY FIRST)</strong>
- Implement <code>providers/generic_url.ts</code> that supports an opinionated mapping to common HTTP AI endpoints (OpenAI-compatible, OpenCode-style, Ollama-style). This demonstrates the correctness of the adapter contract.</p>
<p>Phase 2 ‚Äî <strong>Ollama Provider</strong>
- Thin implementation with streaming-first semantics and compatibility tests against the local Ollama server.</p>
<p>Phase 3 ‚Äî <strong>Kernel Provider (optional)</strong>
- Local kernel adapter; only after core has stabilized.</p>
<hr />
<h2 id="10-conformance-tests-acceptance-criteria">10. Conformance Tests &amp; Acceptance Criteria ‚úÖ</h2>
<p>A provider is conformant when it passes both unit and integration tests. Minimum test cases:</p>
<p>Public contract tests (core):
- <code>generate()</code> rejects invalid message sequences and role values (SDKValidationError).
- <code>stream()</code> throws <code>UnsupportedCapabilityError</code> when provider.streaming === false.
- Normalization enforces token limits when capability declares <code>maxTokens</code>.
- Error types and codes are preserved through the stack.</p>
<p>Provider tests (generic URL &amp; Ollama):
- Provider.capabilities() returns correct capabilities for the configured runtime.
- <code>stream()</code> yields <code>token</code> chunks incrementally for streaming endpoints.
- <code>generate()</code> returns same final text as streamed <code>done</code> concatenation.
- <code>tool_call</code> chunks appear when a provider supports tools and the model emits a tool invocation.</p>
<p>Integration tests:
- Switch runtime between Ollama/OpenAI/URL via <code>RuntimeConfig</code> only and verify identical API behavior.
- Streaming parity tests: ensure <code>generate()</code> and <code>stream()</code> produce consistent outputs and metadata.</p>
<p>Acceptance criteria (same as Completion Criteria in the design document):
1. User can swap providers via configuration only.
2. Streaming works identically across providers.
3. Unsupported features fail loudly.
4. No daemon required.
5. CLI can be built on top of the SDK without modifying providers.</p>
<hr />
<h2 id="11-versioning-compatibility-policy">11. Versioning &amp; Compatibility Policy</h2>
<ul>
<li>v1 is additive-only. Fields cannot be renamed or reinterpreted in v1.</li>
<li>Any breaking changes require a v2 with an explicit migration plan.</li>
<li>Tests must be written that assert backwards compatibility for minor releases.</li>
</ul>
<hr />
<h2 id="12-security-privacy-notes">12. Security &amp; Privacy Notes üîê</h2>
<ul>
<li>The SDK itself makes no assumptions about model safety or content moderation. Those are the caller's responsibility.</li>
<li>Providers must not leak local secrets in error messages or metadata. Providers should sanitize headers and sensitive values before including them in logs or errors.</li>
</ul>
<hr />
<h2 id="13-documentation-onboarding">13. Documentation &amp; Onboarding</h2>
<ul>
<li><code>docs/sdk-principles.md</code> contains the frozen principles (copy the list from the design doc).</li>
<li><code>docs/sdk-contract.md</code> (this file) is the official spec and is authoritative for reviewers and implementers.</li>
<li>Add a small <code>examples/</code> folder with minimal <code>generate</code> and <code>stream</code> examples for each provider.</li>
</ul>
<hr />
<h2 id="14-conformance-checklist-quick">14. Conformance Checklist (quick) ‚úÖ</h2>
<ul>
<li>[ ] <code>generate</code> and <code>stream</code> implemented</li>
<li>[ ] Normalizer validates messages and roles</li>
<li>[ ] Capabilities checked before provider invocation</li>
<li>[ ] Provider contract documented and enforced in tests</li>
<li>[ ] Streaming parity tests present</li>
<li>[ ] Error types present and deterministic</li>
<li>[ ] <code>docs/sdk-principles.md</code> authored</li>
</ul>
<hr />
<h2 id="15-final-lock-statement">15. Final Lock Statement</h2>
<blockquote>
<p>The SDK is a contract, not a product feature. It must be boring, strict, and predictable. Breaking these rules requires a documented migration path and a v2.</p>
</blockquote>
<hr />
<p><em>End of spec.</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>